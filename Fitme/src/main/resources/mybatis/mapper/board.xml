<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 매퍼파일 -->
<mapper namespace="com.ict.fitme.board.dao.BoardMapper">

	<resultMap id="BoardResult" type="BoardDto">
        <id property="bno" column="BNO"/>
        <result property="accountNo" column="ACCOUNT_NO"/>
        <result property="postDate" column="POSTDATE"/>
        <result property="title" column="TITLE"/>
        <result property="hitCount" column="HIT_COUNT"/>
        <result property="boardCategory" column="BOARD_CATEGORY"/>
        <result property="boardComment" column="BOARD_COMMENT"/>
        <result property="address" column="ADDRESS"/>
        <result property="editDate" column="EDITDATE"/>
        <result property="likes" column="LIKES"/>
        <result property="scraps" column="SCRAPS"/>
        <result property="name" column="NAME"/>
    </resultMap>

	<!-- 전체 게시물 조회(사용자명+좋아요+스크랩) -->
	<select id="findByAll" resultType="BoardDto" resultMap="BoardResult">
		SELECT 
			B.*,
			(SELECT A.NAME FROM ACCOUNT A WHERE A.ACCOUNT_NO=B.ACCOUNT_NO) as NAME,
			(SELECT COUNT(BNO) FROM BOARD_LIKES L WHERE L.BNO=B.BNO) AS LIKES,
			(SELECT COUNT(BNO) FROM BOARD_SCRAPS S WHERE S.BNO=B.BNO) AS SCRAPS 
		FROM BOARD B
	</select>
	
	<!-- 특정 게시물 조회 -->
	<select id="findByNo" parameterType="Long" resultType="BoardDto" resultMap="BoardResult">
		SELECT 
			B.*,
			(SELECT A.NAME FROM ACCOUNT A WHERE A.ACCOUNT_NO=B.ACCOUNT_NO) as NAME
	    FROM BOARD B 
	    WHERE B.BNO = #{bno}
	</select>
	<!-- 특정 게시물 조회 마다 조회수 증가 -->
	<update id="incrementHitCount" parameterType="Long">
	    UPDATE BOARD
	    SET HIT_COUNT = HIT_COUNT + 1
	    WHERE BNO = #{bno}
	</update>
	
	<!-- 게시글 등록 -->
	<insert id="save" parameterType="BoardDto">
		<selectKey keyProperty="bno" order="BEFORE" resultType="Long">
				SELECT SEQ_BOARD.NEXTVAL
				FROM DUAL
		</selectKey>
		INSERT INTO BOARD(BNO, ACCOUNT_NO, POSTDATE, TITLE, HIT_COUNT, BOARD_CATEGORY, BOARD_COMMENT, ADDRESS, EDIT_DATE) 
    	VALUES(#{bno}, #{accountNo}, SYSDATE, #{title}, DEFAULT, #{boardCategory}, #{boardComment}, #{address}, null)
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="update" parameterType="BoardDto">
		UPDATE BOARD
		<set>
	        <if test="title != null">TITLE = #{title},</if>
	        <if test="boardComment != null">BOARD_COMMENT = #{boardComment},</if>
	    </set> 
	    , EDIT_DATE=SYSDATE
		WHERE BNO=#{bno} 
	</update>
	
	<!-- 게시글 삭제 -->
	<delete id="delete">
		DELETE FROM BOARD WHERE ACCOUNT_NO=#{accountNo} AND BNO=#{bno}
	</delete>
</mapper>